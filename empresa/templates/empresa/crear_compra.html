{% extends 'empresa/base.html' %}

{% block title %}Registrar Compra{% endblock %}

{% block content %}
<div class="container mt-5" style="max-width: 600px;">
  <h2 class="mb-4 text-primary text-center">Registrar nueva compra</h2>

  <form method="post" class="border p-4 rounded bg-white shadow-sm">
    {% csrf_token %}

    {% if form.errors %}
      <div class="alert alert-danger"><ul class="mb-0">
        {% for field in form %}
          {% for error in field.errors %}
            <li>{{ error }}</li>
          {% endfor %}
        {% endfor %}
        {% for error in form.non_field_errors %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul></div>
    {% endif %}

    <!-- CÃ³digo de Barras -->
    <div class="mb-3">
      <label for="codigo_barras" class="form-label">CÃ³digo de Barras:</label>
      <input type="text" id="codigo_barras" class="form-control" placeholder="Escanea o escribe el cÃ³digo">
    </div>

    <!-- Producto -->
    <div class="mb-3">
      {{ form.producto.label_tag }}
      {{ form.producto }}
    </div>

    <!-- Cantidad -->
    <div class="mb-3">
      {{ form.cantidad.label_tag }}
      {{ form.cantidad }}
    </div>

    <!-- Precio Unitario -->
    <div class="mb-3">
      <label for="precio_unitario" class="form-label">Precio Unitario:</label>
      <input type="text" id="precio_unitario" class="form-control" readonly>
    </div>

    <!-- Total -->
    <div class="mb-3">
      {{ form.total.label_tag }}
      {{ form.total }}
    </div>

    <!-- Stock Info -->
    <div id="stock-info" class="fw-bold mb-3 text-center"></div>

    <button type="submit" class="btn btn-primary w-100">Guardar Compra</button>
  </form>
</div>

<script>
  const productos = {};
  for (const p of {{ productos_json|safe }}) {
    productos[p.id] = p;
  }

  const selectProd = document.getElementById('id_producto');
  const inputCodigo = document.getElementById('codigo_barras');
  const inputCant   = document.getElementById('id_cantidad');
  const inputPrecio = document.getElementById('precio_unitario');
  const inputTotal  = document.getElementById('id_total');
  const stockInfo   = document.getElementById('stock-info');

  function actualizarCompra() {
    const id = selectProd.value;
    const p  = productos[id] || {codigo:'', precio_unitario:0, stock:0};
    const cantidad = parseInt(inputCant.value) || 0;

    inputCodigo.value = p.codigo;
    inputPrecio.value = Number(p.precio_unitario).toFixed(2);

    stockInfo.textContent = `ðŸ” Stock disponible: ${p.stock}`;
    if (cantidad > p.stock) {
      stockInfo.textContent += ' âš ï¸ Excede stock';
      stockInfo.classList.add('text-danger');
      stockInfo.classList.remove('text-success');
    } else {
      stockInfo.classList.toggle('text-success', p.stock>0);
      stockInfo.classList.toggle('text-danger', p.stock===0);
    }

    const total = p.precio_unitario * cantidad || 0;
    inputTotal.value = total.toFixed(2);
  }

  selectProd.addEventListener('change', actualizarCompra);
  inputCant.addEventListener('input', actualizarCompra);
  document.addEventListener('DOMContentLoaded', actualizarCompra);

  inputCodigo.addEventListener('blur', () => {
    const code = inputCodigo.value.trim();
    if (!code) return;
    for (const id in productos) {
      if (productos[id].codigo === code) {
        selectProd.value = id;
        actualizarCompra();
        return;
      }
    }
    alert('Producto no encontrado');
  });
</script>
{% endblock %}
